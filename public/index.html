<!DOCTYPE html>
<html>

<head>
  <title>Web Video Sync</title>
</head>

<body>
  <h1>Web Video Sync</h1>
  <label for="videoUrl">Enter Video URL:</label>
  <input type="text" id="videoUrl">
  <button onclick="setHost()">Set as Host</button>
  <br>
  <label for="sessionId">Enter Session ID:</label>
  <input type="text" id="sessionId">
  <button onclick="joinSession()">Join Session</button>
  <br>
  <video id="videoPlayer" controls></video>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const videoPlayer = document.getElementById('videoPlayer')
    const apiKey = "AIzaSyCSW8QMhryVLlnkhVMpZvb5Q4K1r-cez1c"; // Replace with your API key
    function getFileSourceUrl(url) {
      if (/https:\/\/drive.google.com\/file/.test(url)) {
        console.log("google drive found")
        const fileId = getGoogleDriveFileId(url);
        console.log(fileId)
        if (fileId) {
          const videoSourceUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${apiKey}`;
          videoPlayer.src = videoSourceUrl;
          videoPlayer.play();
          return videoSourceUrl
        }
      }
      return url;
    }
    function getGoogleDriveFileId(url) {
      const regex = /(?:\/d\/|id=|\/file\/d\/)([\w-]{25,})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }
    // Function to set the video URL and notify the host
    function setHost() {
      const videoUrl = document.getElementById('videoUrl').value;
      const formattedUrl = getFileSourceUrl(videoUrl)
      console.log({formattedUrl})
      isHost = true;
      socket.emit('host', formattedUrl);
    }

    // Function to join a session and get the video URL
    function joinSession() {
      const sessionId = document.getElementById('sessionId').value;
      socket.emit('join', sessionId);
    }

    let sessionId;
    let syncInterval;
    let isSeeking = false;
    let isHost = false;

    // Function to sync the video with the host
    function syncVideo() {
      const video = document.getElementById('videoPlayer');
      if (!isSeeking && video.readyState === 4 && !video.paused) {
        socket.emit('sync', sessionId, video.currentTime);
      }
    }

    // Receive the video URL from the host and update the video player
    socket.on('url', (url) => {
      if (url) {
        console.log('Got url from server', url);
        document.getElementById('videoPlayer').src = url;
        document.getElementById('videoPlayer').addEventListener('loadedmetadata', () => {
          // Synchronize the host's video time with all viewers
          syncInterval = setInterval(syncVideo, 500);
        });
      } else {
        document.getElementById('videoPlayer').src = '';
        clearInterval(syncInterval);
      }
    });

    // Receive the session ID from the host and update the frontend
    socket.on('session_created', (createdSessionId) => {
      sessionId = createdSessionId;
      console.log(`Your Session ID: ${sessionId}`);
      console.log(sessionId)
    });

    // Synchronize the video time with the host
    socket.on('sync', (time) => {
      const video = document.getElementById('videoPlayer');
      if (Math.abs(video.currentTime - time) > 0.5) {
        video.currentTime = time;
      }
    });

    // Handle session not found
    socket.on('session_not_found', () => {
      alert('Session not found. Please enter a valid session ID.');
    });

    // Handle session closure by host
    socket.on('session_closed', () => {
      alert('The host has closed the session.');
    });

    // Event listeners for seeking
    document.getElementById('videoPlayer').addEventListener('seeking', () => {
      isSeeking = true;
    });

    document.getElementById('videoPlayer').addEventListener('seeked', () => {
      isSeeking = false;
    });
  </script>
</body>

</html>